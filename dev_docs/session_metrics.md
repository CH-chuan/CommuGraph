# Session Metrics Calculation

This document explains how each session metric is calculated and their relationships.

## Overview

Session metrics are displayed in the **MetricsDashboard** sidebar and provide insights into agent activity, resource usage, and tool performance. Metrics can be filtered by:
- **Main Agent**: Only the main agent's activity
- **All Agents**: Combined main + all sub-agents
- **Specific Sub-agent**: Individual sub-agent metrics

---

## Core Metrics

### 1. Duration (`totalDurationMs`)

**Definition**: Wall-clock time from session start to end.

**Calculation**:
```typescript
// workflow-graph-builder.ts:708
const totalDurationMs = new Date(endTime).getTime() - new Date(startTime).getTime();
```

**Source**: Derived from the `timeRange` in parsed messages:
- `startTime`: Timestamp of the first message
- `endTime`: Timestamp of the last message

**Display Format**:
| Range | Format | Example |
|-------|--------|---------|
| < 1 min | `Xs` | `45s` |
| 1 min - 1 hour | `Xm Ys` | `12m 30s` |
| > 1 hour | `Xh Ym` | `1h 23m` |

**Sub-agent Duration**: For sub-agents, duration is extracted from the `toolUseResult.totalDurationMs` field in the parent Task tool result.

---

### 2. Tokens (`totalTokens`)

**Definition**: Combined input + output tokens used.

**Calculation**:
```typescript
// claude-code-parser.ts:432-434
const totalTokens = messages.reduce((sum, m) => {
  return sum + (m.inputTokens || 0) + (m.outputTokens || 0);
}, 0);
```

**Source**: From Claude API response `usage` object:
```typescript
// claude-code-parser.ts:500-502
response.inputTokens += msg.usage.input_tokens || 0;
response.outputTokens += msg.usage.output_tokens || 0;
```

**Components**:
- `input_tokens`: Tokens sent to the model (prompt + context)
- `output_tokens`: Tokens generated by the model (response)
- `cache_creation_input_tokens`: Tokens cached for reuse (available but not currently aggregated)
- `cache_read_input_tokens`: Tokens read from cache (available but not currently aggregated)

**Important**: The displayed "Tokens" metric is always **input + output combined**, not just one or the other.

**Filter Behavior**:
| Filter | Calculation |
|--------|-------------|
| Main Agent | Sum of tokens from main lane nodes |
| All Agents | Main agent tokens + Σ(sub-agent lane `totalTokens`) |
| Sub-agent X | From lane metadata `totalTokens` or calculated from sub-agent nodes |

---

### 3. Tool Calls (`totalToolCalls`)

**Definition**: Number of tool invocations in the session.

**Calculation**:
```typescript
// MetricsDashboard.tsx:222-227
if (node.nodeType === 'tool_call') {
  toolCalls++;
  if (node.toolName) {
    toolCounts[node.toolName] = (toolCounts[node.toolName] || 0) + 1;
  }
}
```

**Source**: Nodes with `nodeType === 'tool_call'`.

**Note**: Each tool invocation is counted once, regardless of whether it's:
- Part of a parallel execution group
- A Task tool spawning a sub-agent
- A simple utility call (Read, Write, etc.)

---

### 4. Success Rate (`successRate` / `toolSuccessRate`)

**Definition**: Ratio of successful tool results to total results.

**Calculation**:
```typescript
// MetricsDashboard.tsx:237-239
const totalResults = successCount + failureCount;
const successRate = totalResults > 0 ? successCount / totalResults : 1;

// workflow-graph-builder.ts:832-834
const toolSuccessRate = totalToolCalls > 0
  ? successNodes.length / (successNodes.length + failureNodes.length)
  : 1;
```

**Formula**:
```
Success Rate = successCount / (successCount + failureCount)
```

**Counted as Success**:
- `result_success` nodes
- `tool_result` nodes (legacy type, treated as success)

**Counted as Failure**:
- `result_failure` nodes

**Edge Cases**:
- If no results exist, defaults to 100% (1.0)
- Displayed as percentage: `Math.round(successRate * 100)%`

**Color Coding**:
| Rate | Color |
|------|-------|
| > 90% | Green |
| 70-90% | Amber |
| < 70% | Red |

---

## Activity Breakdown

### Node Types

Activity is broken down by node type:

| Type | Label | Color | Description |
|------|-------|-------|-------------|
| `user_input` | User Input | Blue (#3B82F6) | User messages/prompts |
| `agent_reasoning` | Reasoning | Purple (#8B5CF6) | Agent thinking/text responses |
| `tool_call` | Tool Calls | Green (#10B981) | Tool invocations |
| `result_success` | Success | Green (#22C55E) | Successful tool results |
| `result_failure` | Failure | Red (#EF4444) | Failed tool results |
| `tool_result` | Results | Green (#22C55E) | Legacy result type (merged into Success) |
| `system_notice` | System | Slate (#64748B) | System messages |

**Note**: `tool_result` is merged into `result_success` for display so that:
```
Success + Failure = Tool Calls
```

---

## Tool Usage Stats

### Top Tools

Shows the top 10 most-used tools, sorted by count:

```typescript
// MetricsDashboard.tsx:241-243
const sortedTools = Object.entries(toolCounts)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10);
```

Common tools include:
- `Read`: File reading
- `Edit`: File editing
- `Write`: File creation
- `Bash`: Shell commands
- `Grep`: Pattern search
- `Glob`: File pattern matching
- `Task`: Sub-agent spawning

---

## Metric Relationships

### Hierarchy

```
Session
├── Duration
│   └── Derived from: first timestamp → last timestamp
│
├── Tokens (Total)
│   ├── Input Tokens (per request)
│   └── Output Tokens (per request)
│
├── Tool Calls (count)
│   ├── Success Results
│   └── Failure Results
│       └── Derived: Success Rate = success / (success + failure)
│
└── Sub-agents
    ├── Duration (from toolUseResult)
    ├── Tokens (from lane metadata)
    └── Tool Calls (from lane metadata)
```

### Aggregation Rules

| Metric | Main Agent | All Agents | Sub-agent |
|--------|-----------|------------|-----------|
| Duration | Session duration | Session duration | Sub-agent duration |
| Tokens | Σ(main nodes) | main + Σ(sub-agent lanes) | Lane metadata |
| Tool Calls | Σ(main tool_call) | main + Σ(sub-agent lanes) | Lane metadata |
| Success Rate | main results | all results | sub-agent results |

### Data Flow

```
JSONL Log File
     │
     ▼
┌─────────────────────┐
│  ClaudeCodeParser   │
│  - Extract tokens   │
│  - Extract timing   │
│  - Parse tool calls │
└─────────────────────┘
     │
     ▼
┌─────────────────────┐
│ WorkflowGraphBuilder│
│  - Build nodes      │
│  - Calculate totals │
│  - Create lanes     │
└─────────────────────┘
     │
     ▼
┌─────────────────────┐
│  MetricsDashboard   │
│  - Filter by agent  │
│  - Format display   │
│  - Aggregate stats  │
└─────────────────────┘
```

---

## Sub-agent Metrics

Sub-agents (spawned via Task tool) have their own metrics:

### Source

Sub-agent metrics come from two sources:
1. **Lane metadata**: Extracted from parsed sub-agent JSONL files
2. **Calculated**: Aggregated from sub-agent nodes

### Fields

```typescript
interface WorkflowLane {
  totalDurationMs?: number;    // Sub-agent execution time
  totalTokens?: number;        // Sub-agent token usage
  totalToolUseCount?: number;  // Sub-agent tool invocations
  status?: 'completed' | 'failed';
}
```

### All Agents Aggregation

When "All Agents" filter is selected:
```typescript
// MetricsDashboard.tsx:261-267
const subAgentTokens = subAgentLanes.reduce((sum, l) => sum + (l.totalTokens || 0), 0);
const allTokens = mainMetrics.tokens + subAgentTokens;

const subAgentToolCalls = subAgentLanes.reduce((sum, l) => sum + (l.totalToolUseCount || 0), 0);
const allToolCalls = mainMetrics.toolCalls + subAgentToolCalls;
```

---

## Edge Metrics

Edges between nodes also carry timing information:

### Duration Classification

```typescript
const DurationClass = {
  FAST: 'fast',           // < 500ms (green)
  MEDIUM: 'medium',       // 500ms - 2s (yellow)
  SLOW: 'slow',           // 2s - 5s (orange)
  VERY_SLOW: 'very_slow', // > 5s (red)
};
```

Edge duration = `targetNode.timestamp - sourceNode.timestamp`

---

## Anomaly Detection

The system can flag anomalies based on metrics:

| Anomaly Type | Trigger |
|--------------|---------|
| `excessive_tokens` | Token usage exceeds threshold |
| `circular_loop` | Detected cyclic patterns |
| `stagnation` | Repeated similar actions |
| `isolation` | Disconnected components |

Currently, a warning is shown when success rate drops below 90%.

---

## Key Files

| File | Purpose |
|------|---------|
| `src/components/workflow/MetricsDashboard.tsx` | UI display and filtering |
| `src/lib/parsers/claude-code-parser.ts` | Token/timing extraction |
| `src/lib/services/workflow-graph-builder.ts` | Graph construction and metric calculation |
| `src/lib/models/types.ts` | Type definitions |
